<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <title>AI2Bit</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />

  <!-- TFJS & TM Image -->
  <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@4.18.0/dist/tf.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@teachablemachine/image@0.8.5/dist/teachablemachine-image.min.js"></script>

  <style>
    :root{
      --fg:#111;--muted:#666;--bg:#fff;--card:#fafafa;
      --bd:#e5e7eb;--acc:#2563eb;--section-bg:#f9fafb;--accent:#5b21b6;
    }
    *{box-sizing:border-box}
    body{
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
      background:#fff;margin:0;color:var(--fg)
    }

    header,footer{max-width:980px;margin:24px auto 8px;padding:0 16px}

    h1{
      font-size:24px;
      margin:0 0 6px;
      font-weight:700;
    }

    main{
      max-width:980px;margin:0 auto 32px;padding:0 16px;
      display:grid;grid-template-columns:1fr 1fr;gap:16px
    }

    .card{
      background:#fafafa;border:1px solid var(--bd);
      border-radius:14px;padding:14px
    }

    section.card > .block{
      background:var(--section-bg);
      border:1px solid var(--bd);
      border-radius:10px;
      padding:12px;
      margin-top:10px
    }

    .tip{
      font-size:13px;
      font-weight:700;
      color:var(--accent);
      margin-bottom:8px;
      line-height:1.4;
    }

    label{
      display:block;margin:.6rem 0 .25rem;
      font-size:13px;color:#333
    }

    input[type="text"],input[type="number"]{
      width:100%;padding:10px;border:1px solid var(--bd);
      border-radius:10px;background:#fff
    }

    input[readonly]{
      background:#f3f3f3;color:#555;cursor:not-allowed
    }

    .row{display:flex;gap:8px;flex-wrap:wrap;margin-top:8px}

    button{
      padding:9px 12px;border-radius:10px;
      border:1px solid var(--bd);background:#fff;cursor:pointer
    }
    button.primary{
      background:#2563eb;border-color:#2563eb;color:#fff
    }

    .muted{color:var(--muted);font-size:13px}

    #log,#pred{
      height:160px;overflow:auto;padding:10px;
      background:#0b1020;color:#e7f1ff;
      border-radius:10px;
      font-family:ui-monospace,Consolas,monospace
    }
    #pred{height:210px;margin-top:8px}

    video{
      width:100%;display:block;border-radius:12px;background:#000
    }

    .badge{
      background:#eef;border:1px solid #cdd6ff;border-radius:999px;
      padding:2px 8px;font-size:12px;margin-left:6px
    }

    .grid2{display:grid;grid-template-columns:1fr 1fr;gap:8px}

    .copyright{
      max-width:980px;margin:8px auto 24px;padding:0 16px;
      text-align:center;color:#888;font-size:12px
    }
  </style>
</head>

<body>
<header>
  <h1>AI2Bit : Teachable Machine â†’ micro:bit (4 classes)</h1>
</header>

<main>
  <section class="card">

    <!-- 1. URL + ë²„íŠ¼ êµ¬ì—­ -->
    <div class="block">
      <p class="tip">ğŸŸ£ Teachable Machine ëª¨ë¸ URLì„ ì…ë ¥í•˜ì„¸ìš”. (model.jsonì€ ìë™ ì¶”ê°€ë©ë‹ˆë‹¤)</p>

      <input id="modelUrl" type="text"
        placeholder="ì˜ˆ: https://teachablemachine.withgoogle.com/models/XXXX/" />

      <div class="row">
        <button id="loadBtn" class="primary">1) Load model</button>
        <button id="connectBtn">2) Connect micro:bit</button>
        <button id="disconnectBtn">Disconnect</button>
        <button id="startBtn">3) Start</button>
        <button id="stopBtn">Stop</button>
      </div>
    </div>

    <!-- 2. ë¼ë²¨ ìë™í™•ì¸ êµ¬ì—­ -->
    <div class="block">
      <p class="tip">ğŸŸ£ í‹°ì²˜ë¸” ë¨¸ì‹ ì—ì„œ ì…ë ¥í•œ í´ë˜ìŠ¤ëª…ì„ í™•ì¸í•˜ì„¸ìš”.</p>

      <div class="grid2">
        <div>
          <label>Class 1 â†’ ì „ì†¡ ê°’: <b>0</b></label>
          <input id="lab0" type="text" readonly placeholder="ê°€ìœ„" />
        </div>
        <div>
          <label>Class 2 â†’ ì „ì†¡ ê°’: <b>1</b></label>
          <input id="lab1" type="text" readonly placeholder="ë°”ìœ„" />
        </div>
        <div>
          <label>Class 3 â†’ ì „ì†¡ ê°’: <b>2</b></label>
          <input id="lab2" type="text" readonly placeholder="ë³´" />
        </div>
        <div>
          <label>Class 4 â†’ ì „ì†¡ ê°’: <b>3</b></label>
          <input id="lab3" type="text" readonly placeholder="ë°°ê²½" />
        </div>
      </div>

      <div class="muted" style="margin-top:4px">â€» ëª¨ë¸ ë¼ë²¨ì´ ìë™ìœ¼ë¡œ ì±„ì›Œì§‘ë‹ˆë‹¤.</div>
    </div>

    <!-- 3. ì„ê³„ê°’/ë¡œê·¸ êµ¬ì—­ -->
    <div class="block">

      <label class="tip" style="margin-bottom:4px">ğŸŸ£ ì„ê³„ê°’(0~1)</label>

      <input id="threshold" type="number" step="0.01" min="0" max="1" value="0.70" />

      <div class="row" style="margin-top:15px">
        <div class="tip" style="font-weight:700">ğŸŸ£ ìƒíƒœ: <span id="status">ì¤€ë¹„ë¨</span></div>
        <div>ì „ì†¡: <span id="sendState" class="badge">-</span></div>
      </div>

      <div class="row" style="margin-top:20px">
        <span class="muted">í¬íŠ¸ í™•ì¸ìš© â†’ </span>
        <button id="test0">Test 0</button>
        <button id="test1">Test 1</button>
        <button id="test2">Test 2</button>
        <button id="test3">Test 3</button>
      </div>

      <label style="margin-top:15px" class="tip">ğŸŸ£ ë¡œê·¸</label>
      <div id="log"></div>
    </div>
  </section>

  <section class="card">
    <video id="webcam" autoplay playsinline muted></video>

    <div class="muted" style="margin-top:6px">Startë¥¼ ëˆ„ë¥´ë©´ ì¹´ë©”ë¼ ì ‘ê·¼ ê¶Œí•œì„ ìš”ì²­í•©ë‹ˆë‹¤.</div>

    <label style="margin-top:10px">ì˜ˆì¸¡ (Top-3)</label>
    <div id="pred"></div>
  </section>
</main>

<footer class="muted" style="font-size:12px;text-align:center">
  HTTPS + Chrome/Edge í•„ìš”. micro:bitì—ëŠ” UART ìˆ˜ì‹  ì½”ë“œê°€ ì˜¬ë¼ê°€ ìˆì–´ì•¼ í•©ë‹ˆë‹¤.
</footer>

<div class="copyright">
  COPYRIGHT Â© EDUPY ALL RIGHTS RESERVED
</div>

<script>
function $(s){ return document.querySelector(s); }
function log(m){ const e=$('#log'); e.textContent+=m+'
'; e.scrollTop=e.scrollHeight; }
function setStatus(t){ $('#status').textContent=t; }
function setSend(t){ $('#sendState').textContent=t; }

let model, labels=[];
let port, writer, reader;
let running=false, lastSent=null, lastSendTime=0;
const SEND_INTERVAL=140, PRED_INTERVAL=120;
const webcamEl=document.getElementById('webcam');

/* URL ìë™ model.json */
function normalizeModelUrl(url){
  if(!url) return "";
  url=url.trim();
  if(!url.endsWith("/")) url+="/";
  if(!url.endsWith("model.json")) url+="model.json";
  return url;
}

/* ë¼ë²¨ í…ìŠ¤íŠ¸ë°•ìŠ¤ ìë™ ì±„ìš°ê¸° */
function fillLabels(ls){
  if(ls.length>=1) $('#lab0').value=ls[0];
  if(ls.length>=2) $('#lab1').value=ls[1];
  if(ls.length>=3) $('#lab2').value=ls[2];
  if(ls.length>=4) $('#lab3').value=ls[3];
}

/* ëª¨ë¸ ë¼ë²¨ = ì „ì†¡ ì¸ë±ìŠ¤ */
function labelToByte(name){
  const idx = labels.indexOf(name);
  if(idx>=0 && idx<4) return String(idx);
  return "";
}

/* Load model */
async function loadModel(){
  const url=normalizeModelUrl($('#modelUrl').value);
  if(!url){ alert("URLì„ ì…ë ¥í•˜ì„¸ìš”."); return; }

  try{
    model = await tmImage.load(url, url.replace("model.json","metadata.json"));
    labels = model.getClassLabels() || [];
    fillLabels(labels);

    setStatus("âœ… ëª¨ë¸ ë¡œë“œ ì™„ë£Œ");
    log("ë¼ë²¨: "+labels.join(", "));
  }catch(e){
    setStatus("âŒ ëª¨ë¸ ë¡œë“œ ì‹¤íŒ¨");
    log("ì—ëŸ¬: "+e.message);
  }
}

/* Serial Connect */
async function connectSerial(){
  if(!("serial" in navigator)){
    alert("Chrome/Edge ìµœì‹ ë²„ì „ í•„ìš”í•©ë‹ˆë‹¤.");
    return;
  }
  try{
    port = await navigator.serial.requestPort();
    await port.open({baudRate:115200});
    writer = port.writable.getWriter();
    reader = port.readable.getReader();
    setStatus("âœ… micro:bit ì—°ê²°ë¨");
  }catch(e){
    setStatus("âŒ ì—°ê²° ì‹¤íŒ¨");
    log(e.message);
  }
}

/* Disconnect */
$('#disconnectBtn').onclick = async ()=>{
  running=false;
  try{
    if(reader){ try{await reader.cancel();}catch{} reader.releaseLock(); reader=null; }
    if(writer){ try{await writer.close();}catch{} writer.releaseLock(); writer=null; }
    if(port){ try{await port.close();}catch{} port=null; }
    setStatus("ğŸ”Œ ì—°ê²° í•´ì œë¨");
  }catch(e){
    log(e.message);
  }
};

/* Webcam start */
async function startWebcam(){
  if(webcamEl.srcObject) return;
  const stream = await navigator.mediaDevices.getUserMedia({video:true});
  webcamEl.srcObject=stream;
  await webcamEl.play();
}

/* Prediction loop */
async function loopPredict(){
  if(!model || !running) return;

  try{
    const raw = await model.predict(webcamEl);
    const preds = raw.map((p,i)=>({
      label:(p.className || p.label || ("class"+i)),
      prob:p.probability ?? 0
    })).sort((a,b)=>b.prob-a.prob);

    $('#pred').innerHTML =
      preds.slice(0,3).map((r,i)=>`${i+1}. ${r.label} - ${(r.prob*100).toFixed(1)}%`).join("<br>");

    const top=preds[0];
    const thr=parseFloat($('#threshold').value||"0.7");

    if(top && top.prob>=thr){
      const out=labelToByte(top.label);
      const now=performance.now();
      if(writer && out && (out!==lastSent || (now-lastSentTime)>SEND_INTERVAL)){
        await writer.write(new TextEncoder().encode(out));
        setSend(out);
        lastSent=out; lastSentTime=now;
      }
    } else {
      setSend("-");
    }

  }catch(e){
    log("ì˜ˆì¸¡ ì˜¤ë¥˜: "+e.message);
  }

  if(running) setTimeout(loopPredict,PRED_INTERVAL);
}

/* Button binding */
$('#loadBtn').onclick = loadModel;
$('#connectBtn').onclick = connectSerial;

$('#startBtn').onclick = async ()=>{
  if(!model){ alert("ëª¨ë¸ì„ ë¨¼ì € ë¡œë“œí•˜ì„¸ìš”."); return; }
  await startWebcam();
  running=true;
  setStatus("â–¶ï¸ ì˜ˆì¸¡ ì‹¤í–‰ ì¤‘");
  loopPredict();
};

$('#stopBtn').onclick = ()=>{
  running=false;
  setSend("-");
  setStatus("â¸ ì¤‘ì§€ë¨");
};

/* Test buttons */
[0,1,2,3].forEach(i=>{
  document.querySelector('#test'+i).onclick = async ()=>{
    if(!writer){ log("âš  ì—°ê²° ì•ˆ ë¨"); return; }
    await writer.write(new TextEncoder().encode(String(i)));
    setSend(String(i));
    log("Test ì „ì†¡: "+i);
  };
});
</script>

</body>
</html>
